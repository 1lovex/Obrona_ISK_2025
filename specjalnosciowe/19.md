# Pytanie 19. Technologie zapór ogniowych i systemy wykrywania włamań

## Kuba

**[<span style="color:red;">Na podstawie 6 wykładu BSK. </span>](../assets/BSK_6_Filtr.pdf)**

Zapora ogniowa (Firewall) to podstawowy element bezpieczeństwa sieciowego, umieszczany w punkcie styku sieci lokalnej z rozległą lub między segmentami sieci LAN. Jej zadaniem jest filtrowanie ruchu przychodzącego, wychodzącego oraz wewnątrz sieci chronionej.

### Technologie zapór ogniowych

Na prezentacji były wyróżnione cztery główne technologie stosowane w zaporach ogniowych:

#### Filtrowanie pakietów (Packet Filtering)

**Zasada działania:** Selekcja pakietów na podstawie informacji zawartych w nagłówkach warstwy sieciowej i transportowej. Podejmowana jest decyzja o przepuszczeniu (allow) lub odrzuceniu (drop, deny).

**Kryteria filtrowania:**

- **Warstwa sieciowa:** Adresy IP (źródłowy/docelowy), fragmentacja.
- **Warstwa transportowa:** Porty (TCP, UDP), parametry sesji (TCP), kierunki połączeń.

**Cechy:** Wysoka szybkość działania, ale brak weryfikacji samych danych (warstwa aplikacji). Przykład: Blokowanie ruchu z podejrzanych IP na port 22 (SSH).

#### Rozróżnienie filtrów ze względu na stan (Generacje)

- **Filtr bezstanowy (Stateless):** Zapora I generacji. Każdy pakiet analizowany jest indywidualnie, bez kontekstu stanu sesji czy portów powiązanych z poprzednimi pakietami. Nie przechowuje informacji o porcie usługi związanej z przesyłanymi pakietami. Przykład: Proste routery domowe.
- **Filtr z badaniem stanów (Stateful Inspection):** Zapora II generacji. Monitoruje stan całego ruchu na poziomie warstw sieciowej i transportowej. Wie, jakie stany są dozwolone przez protokół, kojarzy pakiety wychodzące z przychodzącymi i automatycznie weryfikuje kolejne etapy nawiązywania połączenia. Przykład: Blokowanie skanowania portów SYN flood.

#### Translacja (maskowanie) adresów sieciowych (NAT)

Mechanizm zmieniający adresy IP sieci wewnętrznej na unikatowe adresy publiczne.

**Zaleta:** Struktura i konkretne adresy hostów wewnątrz sieci chronionej są niewidoczne dla użytkowników zewnętrznych (Internetu). Przykład: Router domowy maskuje prywatne IP 192.168.x.x na publiczne.

#### Filtrowanie w warstwie aplikacji (L7 / Proxy)

Zapora III generacji. Analizuje pakiety na podstawie zawartych w nich danych (treści).

**Zalety:** Możliwość blokowania adresów URL, filtrowanie pod kątem wirusów i trojanów, badanie spójności danych (wykrywanie nieprawidłowo sformatowanych danych).

- **WAF (Web Application Firewall):** Ochrona aplikacji webowych przed atakami typu SQL Injection czy Cross-site Scripting (XSS). Przykład: Blokowanie zapytań z niebezpiecznymi znakami w formularzach.
- **Email Gateway:** Ochrona poczty przed spamem, phishingiem i malware; realizuje również DLP dla poczty wychodzącej. Przykład: Skanowanie załączników na wirusy.
- **Brama warstwy aplikacji (Proxy):** Usługi pośredniczące. Ukrywają użytkowników przed dostępem z Internetu. Przykład: Squid proxy cache'ujący strony.
- **Wady:** Pojedynczy punkt awarii, konieczność współpracy oprogramowania klienckiego z proxy, wymóg osobnego proxy dla każdej usługi.
- **Proxy odwrotne (Reverse Proxy):** Internet widzi farmę serwerów jako jedno urządzenie. Skuteczna obrona przed przejęciem kontroli nad serwerem. Przykład: Load balancer dla serwerów web.

### Wyzwania dla zapór ogniowych

Współczesne zapory muszą mierzyć się z problemami takimi jak:

- **Sieci VPN:** Trudność w filtrowaniu treści, które są zaszyfrowane. Przykład: Tunel VPN omija filtrację.
- **Brak możliwości blokowania portów:** Dotyczy to m.in. protokołu TLS. Przykład: HTTPS na porcie 443 zawsze otwarty.
- **Omijanie zapór:** Przez tunelowanie, błędy w konfiguracji lub niewłaściwą kolejność reguł. Przykład: Atak przez ICMP tunel.

### Architektury budowy zapór ogniowych

- **Router filtrujący:** Proste rozwiązanie, gdy hosty są dobrze zabezpieczone, a liczba protokołów jest niewielka. Przykład: Cisco ACL na routerze.
- **Ekranowany host (Screened Host Gateway):** Router filtrujący (blokuje nieużywane usługi i routing źródłowy) + Brama (host bastionowy pełni funkcję proxy). Przykład: Jeśli bastion zostanie przełamany, dostęp do sieci wewnętrznej.
- **Ekranowana podsieć (Screened Subnet / DMZ):** Najbezpieczniejsza architektura. Wykorzystuje strefę obwodową (DMZ) między routerem zewnętrznym a wewnętrznym. Przykład: Serwery web w DMZ, izolowane od LAN.
- **Wielobramowa architektura:** Zastosowanie oddzielnych bram dla różnych protokołów w celu zwiększenia wydajności i redundancji. Przykład: Osobne proxy dla HTTP i FTP.
- **Wewnętrzne zapory:** Ograniczają zasięg awarii i chronią przed atakami z wewnątrz sieci lokalnej. Przykład: Firewall między departamentami.

### Listy Kontroli Dostępu (ACL) i optymalizacja

- **Mechanizm ACL:** Dopasowanie pakietu do wzorca na podstawie informacji protokołowych. Przykład: Reguła "deny ip 192.168.1.100 any".
- **Dzikie maski (Wildcard Masks):** 0 oznacza bit określony adresem, 1 oznacza bit o dowolnej wartości. Rozpoczynają się zerami, kończą jedynkami. Przykład: 0.0.0.255 dla podsieci.
- **Zasady ACL:** Sprawdzanie sekwencyjne. Po dopasowaniu proces kończy się. Na końcu listy znajduje się domyślne odrzucenie (implicit deny all). Kolejność jest kluczowa (np. najpierw deny specific, potem allow all). Przykład: Błąd kolejności może pozwolić na ruch, który powinien być zablokowany.
- **Optymalizacja:** Umieszczenie reguł o największym współczynniku dopasowania na początku listy. Proces odbywa się offline. Ważne: nie można dowolnie zmieniać kolejności, jeśli reguły dotyczą tych samych pakietów. Przykład: Najpierw reguły dla ruchu wewnętrznego.

### Systemy wykrywania i zapobiegania włamaniom (IDS/IPS)

#### IDS (Intrusion Detection System)

System pasywny. Analizuje ruch i działania, ostrzega o atakach, ale im nie zapobiega. Szybkość nie jest parametrem kluczowym, lecz analiza.

**Etapy działania:** 1. Monitoring -> 2. Przetwarzanie wstępne -> 3. Analiza -> 4. Reakcja -> 5. Dostrajanie.

**Typy:** HIDS (monitoruje hosta/procesy), NIDS (monitoruje segment sieci przez port SPAN lub TAP). Przykład: Snort jako NIDS.

#### IPS (Intrusion Prevention System)

System aktywny. Przeciwdziała atakom w czasie rzeczywistym (np. rekonfiguracja przełączników, zamykanie sesji). Przykład: Blokowanie pakietów z sygnaturą ataku.

**Techniki detekcji:**

- **Wykrywanie nieprawidłowości (anomalii):** Szukanie odchyleń od zachowań "typowych" przy użyciu krzywych parametrycznych (proces uczenia) lub reguł statystycznych (progi dla DoS). Przykład: Nagły wzrost ruchu jako anomalia.
- **Przykłady anomalii:** Ruch na nieużywanym porcie, aktywność po godzinach, nielogiczne dane w nagłówkach.
- **Wykrywanie nadużyć (sygnatury):** Wyszukiwanie znanych wzorców ataków. Precyzyjne, ale tylko dla znanych zagrożeń. Przykład: Wzorzec dla buffer overflow.

**Wady systemów IDS:**

- Generowanie wielkich ilości danych do analizy.
- Fałszywe alarmy / niewykrycie ataku.
- Ograniczona obsługa ruchu szyfrowanego.
- Wymagana wykwalifikowana kadra i wysoka cena.

### Dodatkowe mechanizmy obronne

- **HoneyPot (Garnki miodu):** Przynęta na włamywacza. Cel ochronny (zapobieganie) lub badawczy (nowe zagrożenia). Przykład: Symulowany serwer zbierający dane o atakach.
- **DLP (Data Loss Prevention):** Ochrona przed wyciekiem treści. Wykorzystuje filtrowanie oraz systemy klasyfikacji dokumentów (metadane określające poufność). Kanały wycieku: E-mail, USB, P2P, drukarki, Bluetooth. Przykład: Blokowanie wysyłania plików z metadanymi "tajne".
- **UTM (Unified Threat Management):** Zintegrowane rozwiązanie: Firewall, IDS/IPS, Antywirus, Antyspam, VPN, Filtrowanie treści. Przykład: Palo Alto Networks UTM.
- **SIEM:** Systemy do gromadzenia i korelacji logów (syslog, Netflow, SNMP). Ewoluowały z SEM (wczesne ostrzeganie) oraz SIM (wnioskowanie historyczne). Przykład: IBM QRadar korelujący zdarzenia z wielu źródeł.

### Podsumowanie na obronie

- ✅ **Technologie firewall:** Filtrowanie pakietów (L3/L4), bezstanowe/stateful, NAT (maskowanie), proxy (L7, WAF, Email Gateway, reverse proxy).
- ✅ **Wyzwania:** VPN, brak blokowania portów (TLS), omijanie (tunelowanie, błędy konfiguracji).
- ✅ **Architektury:** Router filtrujący, ekranowany host, DMZ (ekranowana podsieć), wielobramowa, wewnętrzne zapory.
- ✅ **ACL:** Dopasowanie wzorców, dzikie maski, sekwencyjne sprawdzanie, optymalizacja (częste reguły na początku).
- ✅ **IDS/IPS:** IDS (pasywny, alarmuje), IPS (aktywny, blokuje); techniki: anomalie (uczenie, progi), sygnatury (znane wzorce).
- ✅ **Dodatkowe:** HoneyPot (przynęty), DLP (wycieki, metadane), UTM (wszystko w jednym), SIEM (korelacja logów).
- ✅ **Klucz:** Firewall filtruje ruch (allow/deny), IDS/IPS wykrywają ataki; nowoczesna ochrona wymaga integracji (UTM, SIEM) i ochrony przed wyciekami (DLP).

Najważniejsze to rozróżnić filtry (bezstanowe vs. stateful) i systemy wykrywania (IDS alarmuje, IPS blokuje) – klucz do bezpieczeństwa sieciowego.

## Stachu

### Technologie kontroli ruchu

1. **Filtrowanie pakietów (bezstanowy)**
2. **Filtr z badaniem stanów**
3. **Filtrowanie aplikacyjne**
4. **Mechanizm NAT**
5. **Web Application Firewall**
6. **Email Gateway**
7. **Proxy**
   - Normalne
   - Odwrotne

### Systemy wykrywania włamań

1. **Intrusion Detection System (IDS)**

   - Analizuje ruch sieciowy, działania użytkowników i procesów, wykorzystanie zasobów.
   - Wykrywa próby ataku i ostrzega o nich. **NIE ZAPOBIEGA**.
   - Szybkość nie musi być kluczowa.
   - Zadania: monitorowanie, wykrywanie, zapisanie informacji o ataku i powiadomienie admina.
   - Bada sygnatury i/lub analizuje anomalie.

   **Typy IDS:**

   - Host-based (HIDS)
   - Network-based (NIDS)
   - Hybrid

   **Wady IDS:**

   - Brak przeciwdziałania
   - Fałszywe alarmy / niewykrycie ataku
   - Wąskie gardła szybkich sieci
   - Generują wielkie ilości danych do analizy
   - Wymagają wykwalifikowanego personelu
   - Ograniczona obsługa ruchu szyfrowanego
   - Wysoka cena

2. **Intrusion Prevention System (IPS)**

   - Aktywnie przeciwdziała atakom w czasie rzeczywistym (np. dodawanie reguł firewalla, rekonfiguracja przełączników, zamykanie sesji).
   - Połączenie firewalla i IDS.

   **Problemy i wyzwania IPS:**

   - Bardzo szybkie sieci LAN, MAN
   - Środowisko przełączane

3. **HoneyPot**
   - Systemy-przynęty (w pewnym sensie "bait").
   - Dwa główne cele:
     - **Cel ochronny:** Zapobieganie, wykrywanie, reakcja.
     - **Cel badawczy:** Gromadzenie informacji o atakach i nowych zagrożeniach.
